<!DOCTYPE html>
<html lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>科研成果</title>
<link rel="stylesheet" href="jquery-easyui-1.3.3/themes/default/easyui.css">
<link rel="stylesheet" href="jquery-easyui-1.3.3/themes/icon.css">
<script src="jquery-easyui-1.3.3/jquery.min.js"></script>
<script src="jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
<script src="jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
<script>
	let url = null;
	let uploadUrl = null;
	let Id = null;
	let Page = null;
	let type = null;

	$(document).ready(function () {
		Page = parent.$('body')[0].id;
		// 非管理员访问时，隐藏部分页面元素
		if (Page === "userMain") {
			// $("#adminTr")[0].remove();
			// $("#addIcon")[0].remove();
			// $("#delIcon")[0].remove();
			// $("#resetIcon")[0].remove();
			// 获取父页存储的用户ID，随后更改数据的请求地址
			Id = parent.$('#userId')[0].innerText;
		} else if (Page === "adminMain") {
			Id = parent.$('#adminId')[0].innerText;
		}
		$("#dg").datagrid("options").url = getUrl();
	});

	function getUrl() {
		if (Page === "userMain") {
			url = "getResult?type=" + Page + "&userId=" + Id;
		} else if (Page === "adminMain") {
			url = "getResult?type=" + Page;
		}
		return url;
	}

	function searchResult(){
		$('#dg').datagrid('load',{
			resName:$('#s_resName').val(),
			typeId:$('#s_typeId').combobox("getValue")
		});
	}

	function openResultAddDialog(){
		$("#dlg").dialog("open").dialog("setTitle","添加成果信息");
		type = "add";
		url="addResult?type="+type+"&userId="+Id;
	}

	function saveResult(){
		$("#fm").form("submit",{
			url:url,
			onSubmit:function(){
				if ($(this).form("validate")===false){
					return false;
				}
				if ($('#typeId').combobox('getValue') === "") {
					$.messager.alert("系统提示", "请选择成果类型");
					return false;
				}
				return $(this).form("validate");
			},
			success:function(res){
				// res只会返回字符串的true或false，不是布尔类型的true和false
				// 这里的eval函数，是把字符串"true"和"false"解析成布尔类型的true和false
				let result = null;
				if (res === "true" || res === "false") {
					result = eval(res);
				}
				if (result === true) {
					$.messager.alert("系统提示", "保存成功");
					$("#dlg").dialog("close");
					$("#dg").datagrid("reload");
					$("#dg").datagrid("clearChecked");
				} else {
					$.messager.alert("系统提示", "保存失败");
				}
			}
		});
	}

	function resetValue() {
		$("#fm").form("reset");
		$('#typeId').combobox('select', "");
	}

	function closeResultDialog(){
		$("#dlg").dialog("close");
		resetValue();
	}

	function openResultModifyDialog(){
		let selectedRows=$("#dg").datagrid('getSelections');
		if(selectedRows.length!==1){
			$.messager.alert("系统提示","请选择一条要编辑的数据！");
			return;
		}
		let row=selectedRows[0];
		if(row.resStatus===1){
			$.messager.alert("系统提示","审核已经通过！");
			return;
		}
		$("#dlg").dialog("open").dialog("setTitle","编辑成果信息");
		$("#fm").form("load",row);
		type = "update";
		url="addResult?type="+type+"&userId="+Id+"&resId="+row.resId;
	}

	function deleteResult(){
		let selectedRows=$("#dg").datagrid('getSelections');
		if(selectedRows.length===0){
			$.messager.alert("系统提示","请选择要删除的数据！");
			return;
		}
		let strIds=[];
		for(let i=0;i<selectedRows.length;i++){
			strIds.push(selectedRows[i].resId);
		}
		let ids=strIds.join(",");
		$.messager.confirm("系统提示", "您确认要删除这<span style='color:red;'>" + selectedRows.length + "</span>条数据吗？", function (r) {
			if (r) {
				$.post("deleteResult", {ids: ids}, function (result) {
					if (result.success) {
						$.messager.alert("系统提示", "您已成功删除<span style='color:red;'>" + result.num + "</font>条数据！");
						$("#dg").datagrid("reload");
						$("#dg").datagrid("clearChecked");
					}
				}, "json");
			}
		});
	}
	
	function uploadResult(){
		let selectedRows=$("#dg").datagrid('getSelections');
		if(selectedRows.length!==1){
			$.messager.alert("系统提示","请选择一条要编辑的数据！");
			return;
		}
		let row=selectedRows[0];
		if(row.resStatus===1){
			$.messager.alert("系统提示","审核已经通过！");
			return;
		}
		$("#upload").dialog("open").dialog("setTitle","上传成果文件");
		$("#uploadFm").form("load",row);
		uploadUrl="uploadResFile?userId="+Id+"&resId="+row.resId;
	}
	
	function closeUploadResult(){
		$("#upload").dialog("close");
	}
	
	function saveUploadResult(){
		$("#uploadFm").form("submit",{
			url:uploadUrl,
			onSubmit:function(){
				return $(this).form("validate");
			},
			success:function(res){
				// res只会返回字符串的true或false，不是布尔类型的true和false
				// 这里的eval函数，是把字符串"true"和"false"解析成布尔类型的true和false
				let result = null;
				if (res === "true" || res === "false") {
					result = eval(res);
				}
				if (result === true) {
					$.messager.alert("系统提示", "保存成功");
					$("#upload").dialog("close");
					$("#dg").datagrid("reload");
					$("#dg").datagrid("clearChecked");
				} else {
					$.messager.alert("系统提示", "保存失败");
				}
			}
		});
	}

	function formatResStatus(resStatus) {
		if(resStatus===0){
			return "提交";
		}else if(resStatus===1){
			return "通过";
		}else if(resStatus===2){
			return "拒绝";
		}
	}

	function formatResFile(resFile,row) {
		if(resFile){
			return '<a target="_blank" style="color:red;" ' +
				'href="downloadFile/?userId='+row.resId+'">下载'+'</a>';
		}else {
			return "未上传";
		}
	}

</script>
</head>
<body style="margin: 5px;">
	<table id="dg" title="成果信息" class="easyui-datagrid" fitColumns="true"
	 pagination="true" fit="true" rownumbers="true" toolbar="#tb">
		<thead>
			<tr>
				<th field="cb" checkbox="true"></th>
				<th field="resId" width="10" hidden="true">编号</th>
				<th field="typeId" width="20" hidden="true">成果类型编号</th>
				<th field="typeName" width="20">成果类型</th>
				<th field="resName" width="40">名称</th>
				<th field="resDesc" width="80">说明</th>
				<th field="resFile" width="20" formatter="formatResFile">成果</th>
				<th field="userId" width="20" hidden="true">用户编号</th>
				<th field="userTrueName" width="20">提交人</th>
				<th field="collegeName" width="20">所在学院</th>
				<th field="resStatus" width="10" formatter="formatResStatus">状态</th>
				<th field="resDate" width="20">提交时间</th>
			</tr>
		</thead>
	</table>
	<div id="tb">
		<div>
			<a href="javascript:openResultAddDialog()" id="addIcon" class="easyui-linkbutton" iconCls="icon-add" plain="true">添加</a>
			<a href="javascript:openResultModifyDialog()" id="editIcon" class="easyui-linkbutton" iconCls="icon-edit" plain="true">修改</a>
			<a href="javascript:deleteResult()" id="delIcon" class="easyui-linkbutton" iconCls="icon-remove" plain="true">删除</a>
			<a href="javascript:uploadResult()" id="uploadIcon" class="easyui-linkbutton" iconCls="icon-add" plain="true">上传成果</a>
		</div>
		<div>
			<label for="s_resName">&nbsp;名称：&nbsp;</label>
			<input type="text" name="s_resName" id="s_resName" size="10"/>
			<label for="s_typeId">&nbsp;成果类型：&nbsp;</label>
			<input class="easyui-combobox" id="s_typeId" name="s_typeId"
				   data-options="
				   panelHeight:'auto',
				   editable:false,
				   valueField:'typeId',
				   textField:'typeName',
				   url:'getResultType?type=combobox'"/>
		<a href="javascript:searchResult()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
		</div>
	</div>
	<div id="dlg" class="easyui-dialog" style="width: 550px;height: 210px;padding: 10px 20px"
		closed="true" buttons="#dlg-buttons">
		<form id="fm" method="post">
			<table cellspacing="5px;">
				<tr>
					<td><label for="resName">名称：</label></td>
					<td><input type="text" name="resName" id="resName" class="easyui-validatebox" required="true"/></td>
					<td><label for="typeId">成果类型：</label></td>
					<td><input class="easyui-combobox" id="typeId" name="typeId"
							   data-options="
								panelHeight:'auto',
								editable:false,
								valueField:'typeId',
								textField:'typeName',
								url:'getResultType?type=combobox'"/></td>
				</tr>
				<tr>
					<td><label for="resDesc">说明：</label></td>
					<td><textarea type="text" name="resDesc" id="resDesc" class="easyui-validatebox"
								  style="width: 170px;height: 60px;resize: none;"></textarea></td>
				</tr>
			</table>
		</form>
	</div>
	
	<div id="dlg-buttons">
		<a href="javascript:saveResult()" class="easyui-linkbutton" iconCls="icon-ok">保存</a>
		<a href="javascript:closeResultDialog()" class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
	</div>
	<div id="upload" class="easyui-dialog" style="width: 320px;height: 140px;padding: 10px 20px"
		closed="true" buttons="#upload-buttons" data-options="
		onClose:function(){$('#uploadFile')[0].value='';}">
		<form id="uploadFm" method="post" enctype="multipart/form-data">
			<table cellspacing="5px;">
				<tr>
					<td><input type="file" name="uploadFile" id="uploadFile" class="easyui-validatebox"
							   required="true"/></td>
				</tr>
			</table>
		</form>
	</div>
	<div id="upload-buttons">
		<a href="javascript:saveUploadResult()" class="easyui-linkbutton" iconCls="icon-ok">保存</a>
		<a href="javascript:closeUploadResult()" class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
	</div>
</body>
</html>